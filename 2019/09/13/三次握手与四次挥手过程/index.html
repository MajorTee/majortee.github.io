<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Hee"><title>三次握手与四次挥手过程 · HeeC'Blog</title><meta name="description" content="三次握手首先，客户端与服务器均处于未连接状态，并且是客户端主动向服务器请求建立连接：客户端将报文段中的SYN=1，并选择一个seq=x，(即该请求报文的序号为x)  将这个报文发送到服务器。此时，客户端进入同步已发送状态（SYN-SEND）。SYN报文段不能携带数据，但是要消耗掉一个序号。服务器收到"><meta name="keywords" content="text"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/bootstrap.min.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/style.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><meta name="generator" content="Hexo 4.2.0"><link rel="stylesheet" href="/css/prism.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head><body><div id="stage" class="container"><div class="row"><div id="side-bar" class="col-sm-3 col-xs-12 side-container invisible"><div class="vertical-text site-title"><h3 tabindex="-1" class="site-title-small"><a href="/" class="a-title">HeeC</a></h3><h1 tabindex="-1" class="site-title-large"><a href="/" class="a-title">笔记记录</a></h1><!--h6(onclick="triggerSiteNav()") Trigger--></div><br class="visible-lg visible-md visible-sm"><div id="site-nav" class="site-title-links"><section><a href="#">站内搜索</a><div id="site_search"><span style="&lt;%- wrapStyle %&gt;" class="local-search local-search-google local-search-plugin"><input id="local-search-input" type="search" style="&lt;%- inputStyle %&gt;" class="local-search-input-cls"><div id="local-search-result" class="local-search-result-cls"></div></span></div></section><ul><li><a href="/">首页</a></li><li><a href="/archives">归档</a></li><li><a href="/categories">分类</a></li><li><a href="/tags">标签</a></li><li class="soc"><a href="https://github.com/MajorTee" target="_blank" rel="noopener noreferrer"><i class="fa fa-github">&nbsp;</i></a><a href="http://yoursite.com/atom.xml" target="_blank" rel="noopener noreferrer"><i class="fa fa-rss">&nbsp;</i></a></li><div class="visible-lg"><br class="site-nav-footer-br"><br class="site-nav-footer-br"></div></ul><div class="visible-lg visible-md visible-sm site-nav-footer"><br class="site-nav-footer-br"><footer><p>&copy;&nbsp;2020&nbsp;<a target="_blank" href="http://yoursite.com" rel="noopener noreferrer">Hee</a></p><p>Theme&nbsp;<a target="_blank" href="https://github.com/SumiMakito/hexo-theme-typography" rel="noopener noreferrer">Typography</a>&nbsp;by&nbsp;<a target="_blank" href="https://www.keep.moe" rel="noopener noreferrer">Makito</a></p><p>Proudly published with&nbsp;<a target="_blank" href="https://hexo.io" rel="noopener noreferrer">Hexo</a></p></footer></div></div></div><div id="main-container" class="col-sm-9 col-xs-12 main-container invisible"><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post-container"><p class="post-title"><a>三次握手与四次挥手过程</a></p><p class="post-meta"><span class="date meta-item">发布于&nbsp;2019-09-13</span><span class="meta-item"><i class="fa fa-comment-o"></i><span>&nbsp;</span><a href="/2019/09/13/%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E4%B8%8E%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E8%BF%87%E7%A8%8B/#comments">评论</a></span><span class="meta-item"><i class="fa fa-folder"></i><span>&nbsp;</span><a href="/categories/网络/" title="网络" class="a-tag">网络</a><span>&nbsp;</span></span><span class="meta-item"><i class="fa fa-tag"></i><span>&nbsp;</span><a href="/tags/tcp-ip/" title="tcp/ip" class="a-tag">tcp/ip</a><span>&nbsp;</span></span></p><p class="post-abstract"><h1 id="三次握手"><a href="#三次握手" class="headerlink" title="三次握手"></a>三次握手</h1><p>首先，客户端与服务器均处于未连接状态，并且是客户端主动向服务器请求建立连接：<br>客户端将报文段中的SYN=1，并选择一个seq=x，(即该请求报文的序号为x)  将这个报文发送到服务器。此时，客户端进入同步已发送状态（SYN-SEND）。SYN报文段不能携带数据，但是要消耗掉一个序号。<br>服务器收到请求报文后，若同意建立连接，则回复报文中，SYN=1，ACK=1，并选择一个seq = y，且报文中确认号为x+1，序号为y。此时服务器进入同步已接收状态（SYN-RCVD）。</p>
<p>客户端收到服务器的同步确认后，对服务器发送确认的确认。将ACK=1，确认号为y+1，而报文首部的序号为x+1，将该报文发出后，客户端进入已连接状态（ESTABLISHED）。</p>
<p>服务器收到客户端的确认后，也进入已连接状态。<br><a id="more"></a></p>
<p><img src="https://raw.githubusercontent.com/MajorTee/markdp/master/3timeswoshou.png" alt="image"></p>
<p>为何使用三次握手机制？假设如下异常情况：<br>客户端向服务器发送了第一条请求报文，但是该报文并未在网络中被丢弃，而是长时间阻滞在某处，而客户端收不到服务器确认，以为该报文丢失，于是重新发送该报文，这次的报文成功到达服务器，如果不使用三次握手，则服务器只需对该报文发出确认，就建立了一个连接。而在这个连接建立，并释放后，第一次发送的，阻滞在网络中的报文到达了服务器，服务器以为是客户端又重新发送了一个连接请求（实际上在客户端那里，该连接早已失效），就又向客户端发送一个确认，但客户端认为他没有发送该请求报文，因此不理睬服务器发送的确认，而服务器以为又建立了一个新的连接，于是一直等待A发来数据，造成了服务器资源的浪费，并且会产生安全隐患。因此，若使用三次握手机制，服务器发送了该确认后，收不到客户端的确认，也就知道并没有建立连接，因此不会将资源浪费在这种没有意义的等待上。</p>
<h1 id="TCP连接的释放（四次挥手）"><a href="#TCP连接的释放（四次挥手）" class="headerlink" title="TCP连接的释放（四次挥手）"></a>TCP连接的释放（四次挥手）</h1><p>连接的释放较连接的建立复杂。</p>
<p>现假设客户端与服务器均处于连接建立状态，客户端主动断开连接：</p>
<p><img src="https://raw.githubusercontent.com/MajorTee/markdp/master/4timeswoshou.png" alt="image"></p>
<p><img src="https://raw.githubusercontent.com/MajorTee/markdp/master/4timeshuishou.png" alt="image"></p>
<ol>
<li>客户端向服务器发送FIN报文：FIN=1，序号seq=上一个最后传输的字节序号+1=u，发送后，客户端进入FIN-WAIT-1状态。</li>
<li>服务器接收到该报文后，发送一个确认报文：令ACK=1，确认序号ack = u+1，自己的报文序号seq=v，发送后，服务器进入CLOSE-WAIT状态。</li>
<li>此时TCP连接进入连接半关闭状态，服务器可能还会向客户端发送一些数据。</li>
<li>客户端收到来自服务器的确认之后，进入FIN-WAIT-2状态。等待服务器发送连接释放报文。</li>
<li>如果服务器已经没有要发送的数据，则释放TCP连接，向客户端发送报文：令FIN=1，ACK=1，确认号ack =u+1，自己的序号seq = w（w可能等于v也可能大于v），服务器进入LAST-ACK状态。</li>
<li>客户端收到服务器的连接释放报文后，对该报文发出确认，令ACK=1，确认号ack=w+1，自己的序号seq=u+1，发送此报文后，等待2个msl时间后，进入CLOSED状态。</li>
<li>服务器收到客户端的确认后，也进入CLOSED状态并撤销传输控制块。</li>
</ol>
<p>客户端状态变化：未连接——-&gt;SYN-SEND——-&gt;ESTABLISHED——-&gt;FIN-WAIT-1——-&gt;FIN-WAIT-2——-&gt;TIME-WAIT——-&gt;CLOSED</p>
<p>服务器状态变化：未连接——-&gt;SYN-RCVD——-&gt;ESTABLISHED——-&gt;CLOSE-WAIT——-&gt;LAST-ACK——-&gt;CLOSED</p>
<h2 id="通俗描述3次握手就是"><a href="#通俗描述3次握手就是" class="headerlink" title="通俗描述3次握手就是"></a>通俗描述3次握手就是</h2><p>A对B说：我的序号是x，我要向你请求连接；（第一次握手，发送SYN包，然后进入SYN-SEND状态）</p>
<p>B听到之后对A说：我的序号是y，期待你下一句序号是x+1的话（意思就是收到了序号为x的话，即ack=x+1），同意建立连接。（第二次握手，发送ACK-SYN包，然后进入SYN-RCVD状态）</p>
<p>A听到B说同意建立连接之后，对A说：与确认你同意与我连接（ack=y+1，ACK=1，seq=x+1）。（第三次握手，A已进入ESTABLISHED状态）</p>
<p>B听到A的确认之后，也进入ESTABLISHED状态。</p>
<h2 id="描述四次挥手就是："><a href="#描述四次挥手就是：" class="headerlink" title="描述四次挥手就是："></a>描述四次挥手就是：</h2><ol>
<li><p>A与B交谈结束之后，A要结束此次会话，对B说：我要关闭连接了（seq=u，FIN=1）。（第一次挥手，A进入FIN-WAIT-1）</p>
</li>
<li><p>B收到A的消息后说：确认，你要关闭连接了。（seq=v，ack=u+1，ACK=1）（第二次挥手，B进入CLOSE-WAIT）</p>
</li>
<li><p>A收到B的确认后，等了一段时间，因为B可能还有话要对他说。（此时A进入FIN-WAIT-2）</p>
</li>
<li><p>B说完了他要说的话（只是可能还有话说）之后，对A说，我要关闭连接了。（seq=w， ack=u+1，FIN=1，ACK=1）(第三次挥手)</p>
</li>
<li>A收到B要结束连接的消息后说：已收到你要关闭连接的消息。（seq=u+1，ack=w+1，ACK=1）(第四次挥手，然后A进入CLOSED)</li>
<li>B收到A的确认后，也进入CLOSED。</li>
</ol>
</p></div><div class="share"><span>分享到</span>&nbsp;<span class="soc"><a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></span><span class="soc"><a href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));" class="fa fa-weibo"></a></span><span class="soc"><a href="http://twitter.com/home?status=http://yoursite.com/2019/09/13/三次握手与四次挥手过程/%20HeeC' target="_blank" rel="noopener"Blog%20三次握手与四次挥手过程" class="fa fa-twitter"></a></span></div><div class="pagination"><p class="clearfix"><span class="pre pagbuttons"><a role="navigation" href="/2019/09/17/JavaWeb%E5%9B%9B%E5%A4%A7%E5%9F%9F%E5%AF%B9%E8%B1%A1/" title="JavaWeb四大域对象"><i class="fa fa-angle-double-left"></i>&nbsp;上一篇: JavaWeb四大域对象</a></span><span>&nbsp;</span><span class="next pagbuttons"><a role="navigation" href="/2019/09/10/Java%E5%9F%BA%E7%A1%80%E7%AF%87-%E7%AF%87%E5%9B%9B%EF%BC%88%E9%94%81%E6%9C%BA%E5%88%B6%EF%BC%89/" title="Java基础篇-篇四（锁机制）">下一篇: Java基础篇-篇四（锁机制）&nbsp;<i class="fa fa-angle-double-right"></i></a></span></p></div><a id="comments"></a><div id="disqus_thread"></div><script>var disqus_shortname = 'HeeC';
var disqus_identifier = '2019/09/13/三次握手与四次挥手过程/';
var disqus_title = '三次握手与四次挥手过程';
var disqus_url = 'http://yoursite.com/2019/09/13/三次握手与四次挥手过程/';
(function () {
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//HeeC.disqus.com/count.js" async></script></div></div></div><div class="visible-xs site-bottom-footer"><footer><p>&copy;&nbsp;2020&nbsp;<a target="_blank" href="http://yoursite.com" rel="noopener noreferrer">Hee</a></p><p>Theme&nbsp;<a target="_blank" href="https://github.com/SumiMakito/hexo-theme-typography" rel="noopener noreferrer">Typography</a>&nbsp;by&nbsp;<a target="_blank" href="https://www.keep.moe" rel="noopener noreferrer">Makito</a></p><p>Proudly published with&nbsp;<a target="_blank" href="https://hexo.io" rel="noopener noreferrer">Hexo</a></p></footer></div></div></div></div><script src="/js/jquery-3.1.0.min.js"></script><script src="/js/bootstrap.min.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/google-analytics.js"></script><script src="/js/typography.js"></script><script src="/js/search.js"></script><script src="/js/cursor-effects.js"></script></body></html>